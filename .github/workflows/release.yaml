name: Release Process
on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options: [patch, minor, major]
        default: patch
      prerelease_type:
        description: "Prerelease type"
        required: false
        type: choice
        options: [none, beta, rc]
        default: none
      custom_version:
        description: "Custom version (overrides bump_type)"
        required: false
        type: string
      dry_run:
        description: "Dry run mode - closes PR instead of merging"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      version: ${{ steps.bump.outputs.version }}
      branch: ${{ steps.bump.outputs.branch }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - run: pip install bumpver

      - name: Bump Version
        id: bump
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/version-bump.sh "$BUMP_TYPE" "$PRERELEASE_TYPE" "$CUSTOM_VERSION")
          echo "version=$(echo "$OUTPUT" | grep "^version=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$OUTPUT" | grep "^branch=" | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.bump.outputs.version }}
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/create-release-pr.sh)
          echo "pr_url=$(echo "$OUTPUT" | grep "^pr_url=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "pr_number=$(echo "$OUTPUT" | grep "^pr_number=" | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          VERSION: ${{ steps.bump.outputs.version }}
          PR_URL: ${{ steps.pr.outputs.pr_url }}
        run: |
          echo "# ðŸ“¦ Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** $PR_URL" >> $GITHUB_STEP_SUMMARY

  auto-merge-pr:
    name: Auto-merge Release PR
    runs-on: ubuntu-latest
    needs: create-release-pr
    if: ${{ needs.create-release-pr.outputs.pr_number }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ needs.create-release-pr.outputs.pr_number }}
      BRANCH: ${{ needs.create-release-pr.outputs.branch }}
      VERSION: ${{ needs.create-release-pr.outputs.version }}
      DRY_RUN: ${{ inputs.dry_run }}
    steps:
      - uses: actions/checkout@v5

      - name: Wait for PR checks
        id: wait-checks
        run: |
          echo "ðŸ“Š Monitoring PR #$PR_NUMBER checks..."

          # Maximum wait time: 30 minutes
          MAX_WAIT=1800
          INTERVAL=30
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get check status
            CHECK_STATUS=$(gh pr checks $PR_NUMBER --json state,name,conclusion --jq '
              if (.[].state == "PENDING") then
                "pending"
              elif (all(.[]; .conclusion == "SUCCESS" or .conclusion == "SKIPPED")) then
                "success"
              else
                "failed"
              end
            ')

            echo "Check status: $CHECK_STATUS"

            if [ "$CHECK_STATUS" = "success" ]; then
              echo "âœ… All checks passed!"
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              break
            elif [ "$CHECK_STATUS" = "failed" ]; then
              echo "âŒ Some checks failed"
              echo "checks_passed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "â³ Checks still pending... waiting ${INTERVAL}s"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            fi
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "â° Timeout waiting for checks"
            echo "checks_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Approve PR
        if: ${{ steps.wait-checks.outputs.checks_passed == 'true' }}
        run: |
          echo "ðŸ“ Approving PR #$PR_NUMBER..."
          gh pr review $PR_NUMBER --approve --body "Auto-approved by release automation ðŸ¤–"

      - name: Process PR (Dry Run Mode)
        if: ${{ inputs.dry_run && steps.wait-checks.outputs.checks_passed == 'true' }}
        run: |
          echo "ðŸ§ª DRY RUN MODE - Closing PR instead of merging"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Would merge PR #$PR_NUMBER for version $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Instead:** Closing PR and cleaning up branch" >> $GITHUB_STEP_SUMMARY

          # Close PR with a comment
          gh pr close $PR_NUMBER --comment "ðŸ§ª Dry run completed successfully. PR closed without merging."

          # Delete the branch
          echo "ðŸ§¹ Deleting branch $BRANCH..."
          git push origin --delete "$BRANCH" || echo "Branch may already be deleted"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dry run completed successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Merge PR (Production Mode)
        if: ${{ !inputs.dry_run && steps.wait-checks.outputs.checks_passed == 'true' }}
        run: |
          echo "ðŸš€ PRODUCTION MODE - Merging PR"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Production Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Merging PR #$PR_NUMBER for version $VERSION" >> $GITHUB_STEP_SUMMARY

          # TODO: Uncomment when ready for production
          # gh pr merge $PR_NUMBER --squash --auto --delete-branch

          echo "âš ï¸ Merge commands are currently commented out for safety" >> $GITHUB_STEP_SUMMARY
          echo "Uncomment the merge command in the workflow when ready for production use" >> $GITHUB_STEP_SUMMARY
