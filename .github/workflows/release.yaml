name: Release Process
on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - beta
          - rc
        default: "patch"
      custom_version:
        description: "Custom version (optional, overrides bump_type)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create Release PR
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bumpver

      - name: Run Version Bump Script
        id: bump
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          chmod +x .github/scripts/version-bump.sh

          # Run script and capture outputs
          OUTPUT=$(.github/scripts/version-bump.sh "$BUMP_TYPE" "$CUSTOM_VERSION")

          # Extract version and branch from output
          VERSION=$(echo "$OUTPUT" | grep "^version=" | cut -d= -f2)
          BRANCH=$(echo "$OUTPUT" | grep "^branch=" | cut -d= -f2)

          # Set outputs for GitHub Actions
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.bump.outputs.version }}
          BUMP_TYPE: ${{ inputs.bump_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          chmod +x .github/scripts/create-release-pr.sh

          # Run script and capture outputs
          OUTPUT=$(.github/scripts/create-release-pr.sh)

          # Extract PR URL and number from output
          PR_URL=$(echo "$OUTPUT" | grep "^pr_url=" | cut -d= -f2)
          PR_NUMBER=$(echo "$OUTPUT" | grep "^pr_number=" | cut -d= -f2)

          # Set outputs for GitHub Actions
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          # Use printf to safely handle variables
          {
            printf "# ðŸ“¦ Release PR Created\n\n"
            printf "## Version Information\n"
            printf -- "- **New Version:** \`%s\`\n" "${{ steps.bump.outputs.version }}"
            printf -- "- **Bump Type:** %s\n" "${{ inputs.bump_type }}"
            printf -- "- **Custom Version:** %s\n" "${{ inputs.custom_version || 'N/A' }}"
            printf "\n## Pull Request\n"
            printf -- "- **PR Number:** #%s\n" "${{ steps.pr.outputs.pr_number }}"
            printf -- "- **PR URL:** %s\n" "${{ steps.pr.outputs.pr_url }}"
            printf "\n## Next Steps\n"
            printf "1. Review and approve the PR\n"
            printf "2. Merge to trigger tag creation and deployment\n"
            printf "\n---\n"
            printf "*The release process will continue automatically after the PR is merged.*\n"
          } >> $GITHUB_STEP_SUMMARY
