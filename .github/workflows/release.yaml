name: Release Process
on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options: [patch, minor, major]
        default: patch
      prerelease_type:
        description: "Prerelease type"
        required: false
        type: choice
        options: [none, beta, rc]
        default: none
      custom_version:
        description: "Custom version (overrides bump_type)"
        required: false
        type: string
      dry_run:
        description: "Dry run mode - closes PR instead of merging"
        required: false
        type: boolean
        default: true

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      version: ${{ steps.bump.outputs.version }}
      branch: ${{ steps.bump.outputs.branch }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - run: pip install bumpver

      - name: Bump Version
        id: bump
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/version-bump.sh "$BUMP_TYPE" "$PRERELEASE_TYPE" "$CUSTOM_VERSION")
          echo "version=$(echo "$OUTPUT" | grep "^version=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$OUTPUT" | grep "^branch=" | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.bump.outputs.version }}
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/create-release-pr.sh)
          echo "pr_url=$(echo "$OUTPUT" | grep "^pr_url=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "pr_number=$(echo "$OUTPUT" | grep "^pr_number=" | cut -d= -f2)" >> $GITHUB_OUTPUT

  auto-merge-pr:
    name: Auto-merge Release PR
    runs-on: ubuntu-latest
    needs: create-release-pr
    if: ${{ needs.create-release-pr.outputs.pr_number }}
    permissions:
      contents: write
      pull-requests: write
    outputs:
      merge_status: ${{ steps.merge.outputs.action_taken }}
    steps:
      - uses: actions/checkout@v6

      - name: Auto-merge release PR
        id: merge
        uses: ./.github/actions/auto-merge-release-pr
        with:
          pr_number: ${{ needs.create-release-pr.outputs.pr_number }}
          branch: ${{ needs.create-release-pr.outputs.branch }}
          version: ${{ needs.create-release-pr.outputs.version }}
          dry_run: ${{ inputs.dry_run }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  auto-tag-release:
    name: Auto-Tag Release
    runs-on: ubuntu-latest
    needs: [create-release-pr, auto-merge-pr]
    if: ${{ needs.auto-merge-pr.outputs.merge_status == 'merged' || inputs.dry_run == 'true' }}
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and tag release
        uses: ./.github/actions/auto-tag-release
        with:
          version: ${{ needs.create-release-pr.outputs.version }}
          dry_run: ${{ inputs.dry_run }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
