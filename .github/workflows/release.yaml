name: Release Process
on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options: [patch, minor, major]
        default: patch
      prerelease_type:
        description: "Prerelease type"
        required: false
        type: choice
        options: [none, beta, rc]
        default: none
      custom_version:
        description: "Custom version (overrides bump_type)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - run: pip install bumpver

      - name: Bump Version
        id: bump
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/version-bump.sh "$BUMP_TYPE" "$PRERELEASE_TYPE" "$CUSTOM_VERSION")
          echo "version=$(echo "$OUTPUT" | grep "^version=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$OUTPUT" | grep "^branch=" | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.bump.outputs.version }}
          BUMP_TYPE: ${{ inputs.bump_type }}
          PRERELEASE_TYPE: ${{ inputs.prerelease_type }}
          CUSTOM_VERSION: ${{ inputs.custom_version }}
        run: |
          OUTPUT=$(scripts/create-release-pr.sh)
          echo "pr_url=$(echo "$OUTPUT" | grep "^pr_url=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "pr_number=$(echo "$OUTPUT" | grep "^pr_number=" | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          VERSION: ${{ steps.bump.outputs.version }}
          PR_URL: ${{ steps.pr.outputs.pr_url }}
        run: |
          echo "# ðŸ“¦ Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** $PR_URL" >> $GITHUB_STEP_SUMMARY
